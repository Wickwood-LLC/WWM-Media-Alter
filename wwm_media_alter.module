<?php
/**
 * Implements hook_media_wysiwyg_token_to_markup_alter().
 */
function wwm_media_alter_media_wysiwyg_token_to_markup_alter(&$element, $tag_info, $settings) {
  
  $file = $tag_info['file'];
  $fid = $tag_info['fid'];

  if (!empty($settings['wysiwyg'])) {
    dpm('Tag info:');
    dpm($tag_info);
    dpm('Settings:');
    dpm($settings);

    // If sending markup to a WYSIWYG, we need to pass the file information so
    // that an inline macro can be generated when the WYSIWYG is detached.
    // The WYSIWYG plugin is expecting this information in the
    // Drupal.settings.mediaDataMap variable.
    $element = media_wysiwyg_get_file_without_label($file, $tag_info['view_mode'], $settings);
    $data = array(
      'type' => 'media',
      'fid'  => $file->fid,
      'view_mode' => $tag_info['view_mode'],
    );
    drupal_add_js(array('mediaDataMap' => array($file->fid => $data)), 'setting');
    $element['#attributes']['data-fid'] = $file->fid;
    $element['#attributes']['data-media-element'] = '1';
    $element['#attributes']['class'][] = 'media-element';
    $element['#attributes']['class'][] = 'align-center';

    dpm('Settings after:');
    dpm($settings);
    dpm('Element');
    dpm($element);
  }  

  if (!empty($settings['wysiwyg']) || empty($file) || 'image' != $file->type) {
    return;
  }
  $wrapper = entity_metadata_wrapper('file', $file);

  $style = $wrapper->field_alignment->value();

  if (!empty($style)) {
    // foreach ($styles as $style) {
      $element['content']['#attributes']['class'][] = $style;
    // }
  }
  
  // $link = $wrapper->field_myimagelinkfield->value();
  // if (!empty($link['url'])) {
  //   $url = url($link['url']);
  //   $element['content']['file']['#prefix'] = sprintf('<a href="%s">', $url);
  //   $element['content']['file']['#suffix'] = '</a>';
  // }
}

// function wwm_media_alter_media_token_to_markup_alter(&$element, $tag_info, $settings) {
  // $element['#attributes']['class'][] = 'align-center';
  // dpm($element);

  // $file = $tag_info['file'];
  // if (!empty($settings['wysiwyg']) || empty($file) || 'image' != $file->type) {
  //   return;
  // }
  // $wrapper = entity_metadata_wrapper('file', $file);

  // $style = $wrapper->field_alignment->value();

  // if (!empty($style)) {
  //   // foreach ($styles as $style) {
  //     $element['#attributes']['class'][] = 'align-center';
  //   // }
  // }
// }
